@page "/tienda"
@layout EmptyLayout
@inject ILoginService loginService
@inject IHttpServicio http
@inject ICarritoService carritoService
@inject SweetAlertService swal
@attribute [Authorize(Roles = "cliente")]

@Mensaje

<link href="/css/tienda.css" rel="stylesheet" />

<div class="d-flex flex-column min-vh-100">

    <!-- Barra superior -->
    <header class="topbar">
        <div class="brand">YELAZO!</div>
        <button class="cart position-relative btn btn-link text-decoration-none text-white" @onclick="ToggleCarrito">
            <i class="bi bi-cart3"></i>
            Carrito (@cantidadCarrito)
        </button>
    </header>

    <div class="carrito-panel position-fixed top-0 end-0 bg-white shadow-lg p-3 d-flex flex-column"
         style="width:320px; height:100vh; transition: transform .3s ease;
            transform:@(mostrarCarrito ? "translateX(0)" : "translateX(100%)"); z-index:1050;">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="fw-semibold m-0">Mi Carrito</h4>
            <button class="btn-close" @onclick="() => mostrarCarrito = false"></button>
        </div>

        @if (carrito.Detalles != null && carrito.Detalles.Any())
        {
            <div class="flex-grow-1 overflow-auto pe-1">

                @foreach (var detalle in carrito.Detalles)
                {
                    <div class="card mb-3 border-0 shadow-sm">
                        <div class="card-body d-flex justify-content-between align-items-center">

                            <div>
                                <div class="fw-semibold">@detalle.Producto.Nombre</div>

                                <div class="d-flex align-items-center mt-1" style="gap:.4rem;">
                                    <span class="badge bg-primary">@detalle.Cantidad</span>
                                    <span class="badge bg-dark">@detalle.Producto.Precio</span>
                                </div>
                            </div>

                            <button class="btn btn-outline-danger btn-sm rounded-circle d-flex justify-content-center align-items-center"
                                    style="width:30px; height:30px;"
                                    @onclick="() => QuitarProductoAsync(detalle.Producto.Id)">
                                <i class="bi bi-x-lg"></i>
                            </button>

                        </div>
                    </div>
                }

            </div>

            <!-- TOTAL -->
            <div class="border-top pt-3 mt-2">
                <div class="d-flex justify-content-between mb-3">
                    <span class="fw-semibold">Total:</span>
                    <span class="fw-bold fs-5 text-success">$@carrito.Total</span>
                </div>

                <button class="btn btn-success w-100 py-2" @onclick="Pedir">Pedir</button>
            </div>
        }
        else
        {
            <div class="mt-auto text-center text-muted">
                <i class="bi bi-cart-x" style="font-size:2rem;"></i>
                <p class="mt-2">Tu carrito está vacío.</p>
            </div>
        }

    </div>

    <!-- Encabezado -->
    <section class="hero-section text-white text-center py-5 mb-0">
        <div class="container">
            <h1 class="fw-bold display-5 mb-3">SOBRE NOSOTROS</h1>
            <p class="lead mb-0">
               La fabrica N°1 en Cordoba, cumpliendo los estándares más altos en servicio y atención.<br />
                Nos dedicamos a producir, envasar, almacenar y distribuir hielo.
            </p>
        </div>
    </section>

    <!-- Productos -->
    <section class="flex-grow-1 py-5" style="background-color:#F0F8FF;">
        <div class="container">
            <h2 class="text-center fw-bold mb-5 text-dark">Nuestros Productos</h2>

            @if (productos is null)
            {
                <div class="text-center text-secondary py-5">Cargando productos...</div>
            }
            else if (!productos.Any(p => p.Estado))
            {
                <div class="text-center text-muted py-5">No hay productos activos disponibles.</div>
            }
            else
            {
                <div class="row g-4 justify-content-center">
                    @foreach (var producto in productos.Where(p => p.Estado))
                    {
                        <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                            <div class="card product-card border-0 shadow-sm h-100">
                                <div class="position-relative overflow-hidden">
                                    <img src="@imagenPorDefecto"
                                         class="card-img-top product-img"
                                         alt="Imagen de @producto.Nombre" />
                                </div>
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title fw-semibold text-dark mb-2">
                                        @($"{producto.Nombre} {producto.Presentacion}")
                                    </h5>
                                    <p class="card-text text-secondary small flex-grow-1">@producto.Descripcion</p>
                                    <p class="fw-bold text-primary fs-5 mb-3">
                                        @producto.Precio $
                                    </p>
                                    <button class="btn btn-gradient w-100 rounded-pill py-2 mt-auto" @onclick="() => agregarAlCarrito(producto.Id)">
                                        <i class="bi bi-cart-plus me-2"></i> Añadir al Carrito
                                    </button>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer-modern text-white text-center py-4 mt-auto">
        <div class="container">
            <div class="row">
                <div class="col-md-6 mb-3 mb-md-0">
                    <h5 class="fw-bold">HIELO PURO</h5>
                    <p class="small mb-0">
                        Ofrecemos el mejor hielo para todas tus necesidades.<br />
                        Calidad garantizada en cada bolsa.
                    </p>
                </div>
                <div class="col-md-6">
                    <h5 class="fw-bold">Contacto</h5>
                    <p class="small mb-0">
                        info@hielopuro.com<br />
                        +52 (555) 123-4567<br />
                        Avenida Amadeo Sabattini 5313
                    </p>
                </div>
            </div>
            <hr class="border-light opacity-25 my-3" />
            <p class="small mb-0 text-white-50">&copy; 2025 Yelazo. Todos los derechos reservados.</p>
        </div>
    </footer>
</div>

<!-- Modal para seleccionar cantidad -->
@if (mostrarModalCantidad)
{
    <div class="modal fade show d-flex align-items-center justify-content-center"
         style="background-color: rgba(0,0,0,.35); z-index:2000;">

        <div class="modal-dialog modal-dialog-centered" style="max-width: 420px;">
            <div class="modal-content rounded-4 shadow-lg border-0">

                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-semibold">Seleccionar cantidad</h5>
                    <button class="btn-close" @onclick="() => mostrarModalCantidad = false"></button>
                </div>

                <div class="modal-body pt-2">
                    <label class="form-label fw-medium">Cantidad</label>
                    <input type="number"
                           class="form-control form-control-lg rounded-3"
                           min="1"
                           @bind="cantidadSeleccionada" />
                </div>

                <div class="modal-footer border-0 pt-0">
                    <button class="btn btn-light px-4 py-2 rounded-3"
                            @onclick="() => mostrarModalCantidad = false">
                        Cancelar
                    </button>

                    <button class="btn btn-primary px-4 py-2 rounded-3 fw-semibold"
                            @onclick="ConfirmarAgregarCantidadAsync">
                        Agregar
                    </button>
                </div>

            </div>
        </div>
    </div>
}
@code {
    private List<Producto>? productos;
    private string imagenPorDefecto = "https://th.bing.com/th/id/R.69e0e202dc64320acf1b83f533690dc8?rik=sChSobWDBKU%2faA&pid=ImgRaw&r=0";
    public string Mensaje { get; set; } = string.Empty;
    private CarritoDTO carrito = new CarritoDTO();
    private int cantidadCarrito = 0;
    private bool mostrarCarrito = false;
    bool mostrarModalCantidad = false;
    int cantidadSeleccionada = 1;
    int productoSeleccionadoId = 0;

    private void ToggleCarrito()
    {
        mostrarCarrito = !mostrarCarrito;
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await Leer();

        var userId = await loginService.ObtenerIdUsuario();
        if (!string.IsNullOrEmpty(userId))
        {
            carrito = await ObtenerOCrearCarritoAsync(userId);
            // Inicializamos el contador con la cantidad de productos del carrito
            cantidadCarrito = carrito.Detalles?.Sum(d => d.Cantidad) ?? 0;
        }
    }

    private async Task Leer()
    {
        var resp = await http.Get<List<Producto>>("api/Productos");

        if (!resp.Error)
        {
            productos = resp.Respuesta;
        }
        else
        {
            Mensaje = "Error al cargar productos.";
        }
    }

    private async Task Pedir()
    {
        if (carrito == null)
            return;

        try
        {
            //Finalizar carrito actual
            await carritoService.FinalizarCarritoAsync(carrito.Id);


            //Post de la tabla pedidos
            var pedidoResp = await http.Post<object, PedidoDTO>($"api/Pedido/CrearDesdeCarrito/{carrito.Id}", null);
            if (pedidoResp.Error)
            {
                var error = pedidoResp.ObtenerError();
                throw new Exception($"Error al crear el pedido: {error}");
            }

            await swal.FireAsync(new SweetAlertOptions
            {
                Title = "Pedido realizado",
                Text = "Gracias por su compra. Ya estamos preparando su pedido.",
                Icon = SweetAlertIcon.Success,
                ConfirmButtonText = "OK"
            });


            // Crear nuevo carrito
            var usuarioId = await loginService.ObtenerIdUsuario();            
            var nuevo = new CrearCarritoDTO
            {
                UsuarioId = usuarioId,
                FechaCreacion = DateTime.Now
            };

            carrito = await carritoService.CrearCarritoAsync(nuevo);

            cantidadCarrito = carrito.Detalles?.Sum(d => d.Cantidad) ?? 0;

            mostrarCarrito = false;

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al pedir: {ex.Message}");
        }
    }

    // Método para obtener o crear carrito
    private async Task<CarritoDTO> ObtenerOCrearCarritoAsync(string userId)
    {
        var respuesta = await http.Get<CarritoDTO>($"api/Carrito/Activo/{userId}");

        if (!respuesta.Error && respuesta.Respuesta != null)
        {
            Console.WriteLine($"Carrito activo obtenido correctamente, id={respuesta.Respuesta.Id}, Detalles={respuesta.Respuesta.Detalles}");
            return respuesta.Respuesta;
        }
        

        var nuevoCarritoDTO = new
        {
            UsuarioId = userId,
            FechaCreacion = DateTime.Now
        };

        var crearResp = await http.Post<object, CarritoDTO>("api/Carrito", nuevoCarritoDTO);
        if (!crearResp.Error && crearResp.Respuesta != null)
        {
            return crearResp.Respuesta;
        }


            // Si ya existe un carrito activo, volver a pedirlo
            var retry = await http.Get<CarritoDTO>($"api/Carrito/Activo/{userId}");
            if (!retry.Error && retry.Respuesta != null)
            {
                return retry.Respuesta;
            }
        
        throw new Exception("No se pudo obtener ni crear el carrito del usuario.");
    }


    private Task agregarAlCarrito(int productoId)
    {
        productoSeleccionadoId = productoId;
        cantidadSeleccionada = 1; // default
        mostrarModalCantidad = true;
        return Task.CompletedTask;
    }

    private async Task ConfirmarAgregarCantidadAsync()
    {
        try
        {
            if (cantidadSeleccionada < 1)
            {
                Mensaje = "La cantidad debe ser al menos 1.";
                return;
            }

            await carritoService.AgregarProductoAsync(
                carrito.Id,
                productoSeleccionadoId,
                cantidadSeleccionada
            );


            mostrarModalCantidad = false;

            // Actualizar carrito
            var userId = await loginService.ObtenerIdUsuario();
            if (!string.IsNullOrEmpty(userId))
            {
                carrito = await ObtenerOCrearCarritoAsync(userId);
            }

            // Actualizar contador del carrito
            cantidadCarrito = carrito.Detalles?.Sum(d => d.Cantidad) ?? 0;

            StateHasChanged();

            Mensaje = "Producto agregado correctamente.";
        }
        catch (Exception ex)
        {
            Mensaje = $"Error al agregar producto: {ex.Message}";
        }
    }

    private async Task QuitarProductoAsync(int productoId)
    {
        try
        {
            await carritoService.QuitarProductoAsync(carrito.Id, productoId);

            // Actualizamos el carrito desde la API
            var userId = await loginService.ObtenerIdUsuario();
            if (!string.IsNullOrEmpty(userId))
            {
                carrito = await ObtenerOCrearCarritoAsync(userId);
            }

            // Recalcular el total de productos
            cantidadCarrito = carrito.Detalles?.Sum(d => d.Cantidad) ?? 0;

            // Refrescar UI
            StateHasChanged();

            Mensaje = "Producto quitado del carrito correctamente.";
        }
        catch (Exception ex)
        {
            Mensaje = $"Error al quitar el producto: {ex.Message}";
        }
    }

   
}
