@page "/pago/registrar/{pedidoId:int}"
@inject IHttpServicio http
@inject SweetAlertService swal
@inject NavigationManager nav

<h3 class="fw-bold mb-4">Registrar Pago de Pedido #@pedidoId</h3>

@if (pedido == null)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary"></div>
        <p class="mt-3">Cargando datos del pedido...</p>
    </div>
}
else
{
    <div class="card shadow-sm p-4">

        <div class="alert alert-info">
            <h5 class="mb-1"><strong>Cliente:</strong> @pedido.UsuarioNombre</h5>
            <h6 class="mb-0"><strong>Total a pagar:</strong> $@pedido.Total</h6>
        </div>

        <hr />

        <div class="mb-3">
            <label class="form-label fw-semibold">Método de Pago</label>
            <select class="form-select form-select-lg" @bind="metodoPagoId">
                @foreach (var metodo in metodoPagos)
                {
                    <option value="@metodo.Id">@metodo.Nombre</option>
                }
            </select>
        </div>

        <div class="mb-4">
            <label class="form-label fw-semibold">Monto a pagar</label>
            <div class="input-group input-group-lg">
                <span class="input-group-text bg-primary text-white fw-bold">$</span>
                <input class="form-control" type="number" step="0.01" @bind="montoPago" placeholder="0.00" />
            </div>
        </div>

        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <button class="btn btn-success btn-lg px-4" @onclick="RegistrarPago">
                Registrar Pago
            </button>

            <button class="btn btn-outline-secondary btn-lg px-4" @onclick="Volver">
                Cancelar
            </button>
        </div>

    </div>
}

@code {
    [Parameter] public int pedidoId { get; set; }

    PedidoDTO pedido;

    decimal montoPago;

    List<MetodoPago> metodoPagos = new();


    int metodoPagoId = 1;

    protected override async Task OnInitializedAsync()
    {
        await Leer();
        await LeerMetodosPago();
    }

    private async Task Leer()
    {
        var resp = await http.Get<PedidoDTO>($"api/Pedido/{pedidoId}");

        if (!resp.Error)
            pedido = resp.Respuesta;
        else
            await swal.FireAsync("Error", "No se pudo cargar el pedido", SweetAlertIcon.Error);
    }

    private async Task LeerMetodosPago()
    {
        var resp = await http.Get<List<MetodoPago>>("api/MetodoPago");
        if (!resp.Error)
            metodoPagos = resp.Respuesta;
        else
            await swal.FireAsync("Error", "No se pudieron cargar los métodos de pago", SweetAlertIcon.Error);
    }

    private async Task RegistrarPago()
    {
        if (montoPago <= 0)
        {
            await swal.FireAsync("Error", "Debe ingresar un monto válido.", SweetAlertIcon.Error);
            return;
        }

        var dto = new CrearPagoDTO
        {
            PedidoId = pedidoId,
            Monto = montoPago,
            FechaPago = DateTime.Now,
            MetodoPagoId = metodoPagoId
        };

        Console.WriteLine("=== DTO a enviar ===");
        Console.WriteLine($"PedidoId: {dto.PedidoId}");
        Console.WriteLine($"Monto: {dto.Monto}");
        Console.WriteLine($"MetodoPagoId: {dto.MetodoPagoId}");

        var resp = await http.Post<CrearPagoDTO, object>("api/Pago", dto);

        Console.WriteLine("=== RESPUESTA ===");
        Console.WriteLine("Error: " + resp.Error);
        Console.WriteLine("Mensaje: " + resp.HttpResponseMessage);

        if (!resp.Error)
        {
            await swal.FireAsync("Éxito", "Pago registrado correctamente", SweetAlertIcon.Success);

            nav.NavigateTo("/pedidos");
        }
        else
        {
            await swal.FireAsync("Error", "No se pudo registrar el pago", SweetAlertIcon.Error);
        }
    }

    void Volver()
    {
        nav.NavigateTo("/pedidos");
    }
}